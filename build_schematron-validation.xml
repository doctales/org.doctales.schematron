<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  Copyright 2017 DOCTALES. All rights reserved.
  See the accompanying LICENSE file for applicable license.
-->
<project basedir="." name="build_dita2schematron">

    <import file="build_taskdef_ph-schematron.xml"/>
    <import file="build_taskdef_ant-contrib.xml"/>
  
    <target name="schematron-validation">
        <property name="schematron.processing.engine" value="pure"/>
        
        <!-- Schematron DITA-Map validation -->
        <property name="schematron.map.validation.file.absolute" location="${user.dir}/${schematron.map.validation.file}"/>
        <if>
            <and>
                <isset property="schematron.map.validation.file"/>
                <available file="${schematron.map.validation.file.absolute}"/>
            </and>
            <then>
                <antcall target="schematron-validate-maps"/>
            </then>
            <elseif>
                <not>
                    <isset property="schematron.map.validation.file"/>
                </not>
                <then>
                    <echo>'schematron.map.validation.file' is not set, skip Schematron DITA-Map validation</echo>
                </then>
            </elseif>
            <elseif>
                <and>
                    <isset property="schematron.map.validation.file"/>
                    <not>
                        <available file="${schematron.map.validation.file.absolute}"/>
                    </not>
                </and>
                <then>
                    <echo>Schematron map validation file '${schematron.map.validation.file.absolute}' is not found, skip DITA-Map validation</echo>
                </then>
            </elseif>
        </if>
        
        <!-- Schematron DITA-Topic validation -->
        <property name="schematron.topic.validation.file.absolute" location="${user.dir}/${schematron.topic.validation.file}"/>
        <if>
            <and>
                <isset property="schematron.topic.validation.file"/>
                <available file="${schematron.topic.validation.file.absolute}"/>
            </and>
            <then>
                <antcall target="schematron-validate-topics"/>
            </then>
            <elseif>
                <not>
                    <isset property="schematron.topic.validation.file"/>
                </not>
                <then>
                    <echo>'schematron.topic.validation.file' is not set, skip Schematron DITA-Topic validation</echo>
                </then>
            </elseif>
            <elseif>
                <and>
                    <isset property="schematron.topic.validation.file"/>
                    <not>
                        <available file="${schematron.topic.validation.file.absolute}"/>
                    </not>
                </and>
                <then>
                    <echo>Schematron topic validation file '${schematron.topic.validation.file.absolute}' is not found, skip DITA-Topic validation</echo>
                </then>
            </elseif>
        </if>
    </target>

    <target name="schematron-validate-maps">
        <loadfile srcfile="${dita.temp.dir}/fullditamap.list" property="fullditamap.list.file"/>
        <echo>fullditamap.list.file=${fullditamap.list.file}</echo>
        <for list="${fullditamap.list.file}" param="map.file" delimiter="${line.separator}">
            <sequential>
                <echo level="verbose">Validate '@{map.file}' with '${schematron.map.validation.file.absolute}'</echo>
                <schematron
                    schematronFile="${schematron.map.validation.file.absolute}"
                    expectSuccess="true"
                    schematronProcessingEngine="${schematron.processing.engine}">
                    <fileset dir="${dita.temp.dir}">
                        <include name="@{map.file}"/>
                    </fileset>
                    <xmlcatalog refid="dita.catalog"/>
                </schematron>
            </sequential>
        </for>
    </target>

    <target name="schematron-validate-topics">
        <loadfile srcfile="${dita.temp.dir}/fullditatopic.list" property="fullditatopic.list.file"/>
        <echo>fullditatopic.list.file=${fullditatopic.list.file}</echo>
        <for list="${fullditatopic.list.file}" param="topic.file" delimiter="${line.separator}">
            <sequential>
                <echo level="verbose">Validate '@{topic.file}' with '${schematron.topic.validation.file.absolute}'</echo>
                <schematron
                    schematronFile="${schematron.topic.validation.file.absolute}"
                    expectSuccess="true"
                    schematronProcessingEngine="${schematron.processing.engine}">
                    <fileset dir="${dita.temp.dir}">
                        <include name="@{topic.file}"/>
                    </fileset>
                    <xmlcatalog refid="dita.catalog"/>
                </schematron>
            </sequential>
        </for>
    </target>
    
</project>
